HDF2HEPnOS
==========

This utility is used to scan an HDF5 file generated by FNAL's High Energy Physics experiments,
and generate C++ code for classes representing data products.

## Dependencies

HDF2HEPnOS requires the following dependencies.

  * HDF5
  * Python 3.3 or greater
  * h5py
  * Jinja2

You can install HDF2HEPnOS with spack as follows.
First, clone and add the sds-repo if you don't yet have it:

```
git clone https://xgitlab.cels.anl.gov/sds/sds-repo.git
spack repo add sds-repo
```

You can then install HDF5HEPnOS as follows:
```
spack install py-hepnos-hdf2hepnos
```

## HDF5 file structure

The program assumes that HDF5 files have a particular structure.
The file must contains a set of groups. For each group, a C++ structure will be generated.
The name of this structure will be the name of the group, will special characters (e.f. /, ., etc.)
replaced with underscores.

Each group contains a set of one-dimentional dataset, all of the same extent. These
datasets represent columns. For each column, a member variable will be added to the C++ structure.
The _run_, _subrun_, and _evt_ columns represent the run, subrun, and event number of a
particular data product. These three columns will not be added to the C++ structure.

## Code generation

HDF2HEPnOS uses [Jinja2](http://jinja.pocoo.org/docs/2.10/) to generate C++ code from a template.
Each group in the input HDF5 file will lead to the generation of a file containing a C++ structure.
This structure will have the necessary member variables, as well as a _serialize_ template
method for Boost to use, and two _from_hdf5_ methods to read the data from an HDF5 file using
HDF5's C API.

Code generation is done as follows.

```
hdf2hepnos --input myHDFfile.h5 --output directory/for/generated/code --namespace ABC
```

If `--output` is ommited, the current working directory is used.
The `--namespace` option is optional and allow one to place all the generated C++ classes
into a particular namespace.

## Using the _from_hdf5_ functions

The _from_hdf5_ functions either take the name of an HDF5 file from which to extract
the data, or directly the `hid_t` file identifier pointing to an opened HDF5 file.
They also either take a callback to execute on each object read from the file,
or return an `std::tuple` of four vectors, containing respectively the run numbers,
subrun numbers, event number, and data product.

## Example

You can find an example in the _test_ directory. With the right packages loaded, place an HDF5
file named _test.h5_ into the test directory (this file must adhere to the format above)
and execute the following from the root of this repository.

```
cd test
make
```
This will scan the _test.h5_ file and create a _gen_ folder with the generated C++ code, then compile
an example program that reads the _test.h5_ file and count the objects of type `rec_vtx_elastic_fuzzyk_png2d`
(which is assumed to be one of the groups in the HDF5 file).
